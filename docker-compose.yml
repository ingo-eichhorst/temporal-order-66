
services:
  postgres:
    image: postgres:14
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      # Create both databases on startup
      POSTGRES_MULTIPLE_DATABASES: temporal,langfuse
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./docker/postgres-init.sh:/docker-entrypoint-initdb.d/init.sh
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  temporal:
    image: temporalio/auto-setup:1.24.2
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=postgres
      - POSTGRES_PWD=postgres
      - POSTGRES_SEEDS=postgres
      - POSTGRES_DB=temporal
    ports:
      - "7233:7233"  # gRPC
    healthcheck:
      test: ["CMD", "tctl", "--address", "temporal:7233", "cluster", "health"]
      interval: 5s
      timeout: 5s
      retries: 10

  temporal-ui:
    image: temporalio/ui:2.22.3
    depends_on:
      temporal:
        condition: service_healthy
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:8233
    ports:
      - "8233:8080"  # Web UI

  langfuse:
    image: langfuse/langfuse:2
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/langfuse
      NEXTAUTH_URL: http://localhost:3000
      NEXTAUTH_SECRET: changeme-generate-a-secret-here-use-openssl-rand-base64-32
      SALT: changeme-generate-salt-here-use-openssl-rand-base64-32
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3000/api/public/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

  agent-a:
    build: ./agent-a
    depends_on:
      temporal:
        condition: service_healthy
    environment:
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-}
      - LANGFUSE_HOST=http://langfuse:3000
      - TEMPORAL_SERVER=temporal:7233
      - TEMPORAL_NAMESPACE=a2a-demo
      - AGENT_A_URL=http://agent-a:8081
      - AGENT_B_URL=http://agent-b:8080
      - PORT=8081
      - DEMO_DRIVER_PORT=8082
    ports:
      - "8081:8081"  # A2A endpoint
      - "8082:8082"  # Demo driver
    restart: unless-stopped

  agent-b:
    build: ./agent-b
    depends_on:
      temporal:
        condition: service_healthy
    environment:
      - LM_STUDIO_BASE_URL=${LM_STUDIO_BASE_URL:-http://host.docker.internal:1234/v1}
      - LM_STUDIO_API_KEY=${LM_STUDIO_API_KEY:-lm-studio}
      - LM_STUDIO_MODEL=${LM_STUDIO_MODEL:-google/gemma-3-1b}
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-}
      - LANGFUSE_HOST=http://langfuse:3000
      - TEMPORAL_SERVER=temporal:7233
      - TEMPORAL_NAMESPACE=a2a-demo
      - AGENT_A_URL=http://agent-a:8081
      - AGENT_B_URL=http://agent-b:8080
      - PORT=8080
    ports:
      - "8080:8080"  # A2A endpoint
    restart: unless-stopped

volumes:
  postgres-data:
